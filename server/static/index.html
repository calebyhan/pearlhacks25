<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Visual911 — Dispatcher</title>
  <link rel="icon" type="image/svg+xml" href="/static/logo.svg">

  <!-- Leaflet.js for map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #0a0a0f; color: #e0e0e0; font-family: 'SF Pro', system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; }

    #header {
      padding: 12px 20px;
      background: #111118;
      border-bottom: 1px solid #222;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    #header h1 { font-size: 20px; font-weight: 700; color: #fff; letter-spacing: 0.08em; }
    #conn-status { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
    #conn-dot { width: 10px; height: 10px; border-radius: 50%; background: #ff3333; transition: background 0.3s; }
    #conn-status.connected #conn-dot { background: #2ecc71; }
    #conn-label { font-size: 13px; color: #888; transition: color 0.3s; }
    #conn-status.connected #conn-label { color: #2ecc71; }

    #incoming-banner {
      display: none;
      margin-left: auto;
      background: rgba(255, 51, 51, 0.08);
      border: 1px solid #333;
      border-radius: 999px;
      padding: 8px 16px;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      color: #ccc;
    }
    #incoming-banner.visible { display: flex; }
    #incoming-banner .pulse { width: 10px; height: 10px; border-radius: 50%; background: #ff3333; animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    #answer-btn {
      background: transparent;
      color: #2ecc71;
      border: 1px solid #2ecc71;
      border-radius: 999px;
      padding: 6px 18px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: 0.06em;
      transition: background 0.2s, color 0.2s;
    }
    #answer-btn:hover { background: #2ecc71; color: #000; }

    #main-grid {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 14px;
      background: #0a0a0f;
      overflow: hidden;
      padding: 18px 24px 24px;
    }

    .panel {
      background: #101015;
      padding: 18px;
      overflow: hidden;
      border-radius: 22px;
      box-shadow: 0 22px 40px rgba(0,0,0,0.6);
    }
    .panel-title { font-size: 18px; font-weight: 650; letter-spacing: 0.12em; text-transform: uppercase; color: #a0a0a0; margin-bottom: 12px; }

    /* Video panel */
    #video-panel {
      grid-row: 1 / span 2;
      grid-column: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    #remote-video {
      width: 100%;
      height: 100%;
      min-height: 0;
      flex: 1;
      object-fit: cover;
      background: #000;
      border-radius: 20px;
      cursor: pointer;
      transform: scaleX(-1);
    }
    /* Vitals panel */
    #vitals-panel { grid-row: 1; grid-column: 2; display: flex; flex-direction: column; overflow-y: auto; min-width: 0; }
    .vital-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px; }
    .vital-label { font-size: 16px; color: #dddddd; }
    .vital-value { font-size: 40px; font-weight: 700; color: #fff; }
    .vital-unit { font-size: 16px; color: #888; margin-left: 4px; }
    .confidence-bar { height: 4px; background: #222; border-radius: 2px; margin-bottom: 16px; }
    .confidence-fill { height: 100%; border-radius: 2px; background: #00cc44; transition: width 0.5s; }
    #signal-lost { display: none; color: #ff6600; font-size: 14px; text-align: center; padding: 8px; background: #1a0f00; border-radius: 4px; }

    /* Triage panel */
    #triage-panel { grid-row: 1; grid-column: 3; display: flex; flex-direction: column; overflow-y: auto; min-width: 0; }
    .severity-bar { display: flex; gap: 4px; margin-bottom: 12px; }
    .severity-dot { flex: 1; height: 8px; border-radius: 2px; background: #222; }
    .severity-dot.active { background: #ff3333; }
    .severity-dot.active.low { background: #00cc44; }
    .severity-dot.active.mid { background: #ffaa00; }
    .triage-field { margin-bottom: 12px; }
    .triage-field-label { font-size: 13px; color: #777; text-transform: uppercase; letter-spacing: 0.09em; }
    .triage-field-value { font-size: 17px; color: #f0f0f0; margin-top: 2px; line-height: 1.4; }
    #critical-alert {
      display: none;
      background: #ff0000;
      color: white;
      font-weight: 700;
      font-size: 16px;
      text-align: center;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 12px;
      animation: flashred 0.5s infinite;
    }
    @keyframes flashred { 0%, 100% { background: #ff0000; } 50% { background: #880000; } }

    /* Map panel */
    #map-panel { grid-row: 2; grid-column: 2 / span 2; display: flex; flex-direction: column; }
    #map { width: 100%; flex: 1; min-height: 0; border-radius: 18px; overflow: hidden; }

    /* Video controls bar */
    #video-controls {
      display: none;
      position: absolute;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      gap: 20px;
      align-items: center;
      z-index: 10;
    }
    #video-controls.visible { display: flex; }
    .vc-btn {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.5);
      transition: transform 0.15s, opacity 0.15s;
    }
    .vc-btn:hover { transform: scale(1.1); }
    .vc-btn:active { transform: scale(0.95); }
    #mute-btn { background: rgba(255,255,255,0.15); color: #fff; backdrop-filter: blur(8px); }
    #mute-btn.muted { background: rgba(255,255,255,0.3); }
    #vc-end-btn { background: #ff4b4b; color: #fff; }

    body.critical-state { animation: criticalFlash 1s infinite; }
    @keyframes criticalFlash { 0%, 100% { border: 3px solid transparent; } 50% { border: 3px solid #ff0000; } }

    /* Community metrics bar */
    #community-metrics {
      display: flex;
      gap: 20px;
      padding: 6px 20px;
      background: #0d0d14;
      border-bottom: 1px solid #1a1a22;
      font-size: 13px;
      color: #888;
    }
    .cm-stat { display: flex; align-items: center; gap: 6px; }
    .cm-stat .cm-val { font-weight: 700; color: #e0e0e0; font-size: 15px; transition: color 0.3s; }
    .cm-stat.hot .cm-val { color: #ff6644; }
    @keyframes metricFlash { 0% { color: #fff; } 60% { color: #ff6644; } 100% { color: #ff6644; } }
    .cm-val.flash { animation: metricFlash 0.5s ease-out forwards; }

    /* Incident marker badges on map */
    .incident-badge {
      background: #ff3333;
      color: #fff;
      font-weight: 700;
      font-size: 13px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(255,51,51,0.5);
      border: 2px solid #fff;
    }
    .incident-badge.sev-low { background: #00cc44; }
    .incident-badge.sev-mid { background: #ffaa00; color: #000; }
  </style>
</head>
<body>

<div id="header">
  <h1>VISUAL911</h1>
  <div id="conn-status" title="Disconnected"><div id="conn-dot"></div><span id="conn-label">Disconnected</span></div>
  <div id="incoming-banner">
    <div class="pulse"></div>
    <span>Incoming call</span>
    <span id="incoming-location" style="color:#666;font-size:13px;"></span>
    <button id="answer-btn">ANSWER</button>
  </div>
</div>

<div id="community-metrics">
  <div class="cm-stat" id="cm-incidents">Active Incidents: <span class="cm-val">0</span></div>
  <div class="cm-stat" id="cm-reports">Total Reports: <span class="cm-val">0</span></div>
  <div class="cm-stat" id="cm-alerted">Users Alerted: <span class="cm-val">0</span></div>
</div>

<div id="critical-alert" style="display:none;margin:8px 20px;border-radius:6px;text-align:center;padding:10px;font-weight:700;background:#ff0000;color:#fff;"></div>

<div id="main-grid">
  <div class="panel" id="video-panel">
    <div class="panel-title">Live Feed</div>
    <video id="remote-video" autoplay playsinline muted></video>
    <div id="video-controls">
      <button class="vc-btn muted" id="mute-btn" title="Toggle audio">
        <svg id="mute-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="1" y1="1" x2="23" y2="23"></line>
          <path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path>
          <path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2c0 .76-.12 1.5-.34 2.18"></path>
          <line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line>
        </svg>
      </button>
      <button class="vc-btn" id="vc-end-btn" title="End call">✕</button>
    </div>
  </div>

  <div class="panel" id="vitals-panel">
    <div class="panel-title">Vitals</div>

    <div id="signal-lost">⚠ Signal lost / low confidence</div>

    <div class="vital-row">
      <span class="vital-label">❤ Heart Rate</span>
    </div>
    <div>
      <span class="vital-value" id="hr-value">--</span>
      <span class="vital-unit">bpm</span>
    </div>
    <div class="confidence-bar"><div class="confidence-fill" id="hr-conf" style="width:0%"></div></div>

    <div class="vital-row">
      <span class="vital-label">↕ Breathing Rate</span>
    </div>
    <div>
      <span class="vital-value" id="br-value">--</span>
      <span class="vital-unit">/min</span>
    </div>
    <div class="confidence-bar"><div class="confidence-fill" id="br-conf" style="width:0%"></div></div>

    <div style="font-size:12px;color:#555;margin-bottom:8px;">From pre-call scan</div>
  </div>

  <div class="panel" id="triage-panel">
    <div class="panel-title">AI Triage</div>

    <div class="severity-bar">
      <div class="severity-dot" id="sev1"></div>
      <div class="severity-dot" id="sev2"></div>
      <div class="severity-dot" id="sev3"></div>
      <div class="severity-dot" id="sev4"></div>
      <div class="severity-dot" id="sev5"></div>
    </div>
    <div style="font-size:12px;color:#666;margin-bottom:10px;">Severity: <span id="severity-label">--</span>/5</div>

    <div class="triage-field">
      <div class="triage-field-label">Situation</div>
      <div class="triage-field-value" id="situation">Waiting for analysis...</div>
    </div>
    <div class="triage-field">
      <div class="triage-field-label">Caller State</div>
      <div class="triage-field-value" id="emotional-state">--</div>
    </div>
    <div class="triage-field">
      <div class="triage-field-label">Response Type</div>
      <div class="triage-field-value" id="response-type">--</div>
    </div>
    <div class="triage-field">
      <div class="triage-field-label">Can Speak</div>
      <div class="triage-field-value" id="can-speak">--</div>
    </div>
    <div class="triage-field">
      <div class="triage-field-label">Keywords</div>
      <div class="triage-field-value" id="keywords">--</div>
    </div>
  </div>

  <div class="panel" id="map-panel">
    <div class="panel-title">Location</div>
    <div id="map"></div>
  </div>
</div>



<script>
// ─── State ────────────────────────────────────────────────────────────────────
let ws = null;
let peerConnection = null;
let currentCallId = null;
let map = null;
let mapMarker = null;

// Community alert state
const incidentData = {};      // {incident_id: {location, report_count, alerted_count, severity}}
const incidentMarkers = {};   // {incident_id: L.marker}

// ─── Map ─────────────────────────────────────────────────────────────────────
function initMap() {
  map = L.map('map').setView([35.9, -79.05], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(map);
}

function updateMapPin(lat, lng) {
  if (!map) initMap();
  const latlng = [lat, lng];
  if (mapMarker) {
    mapMarker.setLatLng(latlng);
  } else {
    mapMarker = L.marker(latlng).addTo(map).bindPopup('Caller location').openPopup();
  }
  map.setView(latlng, 15);
}

// ─── WebRTC ───────────────────────────────────────────────────────────────────
let iceServers = [
  { urls: 'stun:stun.l.google.com:19302' },
  { urls: 'stun:stun1.l.google.com:19302' },
];

// Fetch TURN credentials from server
async function loadTURNCredentials() {
  try {
    const resp = await fetch('/api/turn-credentials');
    const data = await resp.json();
    iceServers.push({
      urls: data.urls,
      username: data.username,
      credential: data.credential,
    });
    console.log('TURN credentials loaded');
  } catch (e) {
    console.warn('Could not load TURN credentials:', e);
  }
}
loadTURNCredentials();

function createPeerConnection() {
  peerConnection = new RTCPeerConnection({ iceServers });

  peerConnection.onicecandidate = (event) => {
    if (event.candidate && ws) {
      console.log('Sending ICE:', event.candidate.candidate.substring(0, 80));
      ws.send(JSON.stringify({
        type: 'ice',
        call_id: currentCallId,
        candidate: event.candidate.candidate,
        sdpMid: event.candidate.sdpMid,
        sdpMLineIndex: event.candidate.sdpMLineIndex
      }));
    }
  };

  peerConnection.ontrack = (event) => {
    console.log('Got remote track:', event.track.kind, event.streams.length, 'streams');
    const video = document.getElementById('remote-video');
    if (!video.srcObject) {
      video.srcObject = event.streams[0];
      video.play().then(() => console.log('Video playing')).catch(e => console.error('Play failed:', e));
    }
    event.track.onunmute = () => console.log('Track unmuted:', event.track.kind);
    event.track.onended = () => console.log('Track ended:', event.track.kind);
    // Log video dimensions once they're available
    if (event.track.kind === 'video') {
      video.onloadedmetadata = () => console.log('Video resolution:', video.videoWidth, 'x', video.videoHeight);
    }
    // Video starts muted (browser autoplay policy). Use mute button to toggle.
  };

  peerConnection.oniceconnectionstatechange = () => {
    console.log('ICE state:', peerConnection.iceConnectionState);
  };
  peerConnection.onconnectionstatechange = () => {
    console.log('WebRTC state:', peerConnection.connectionState);
    if (peerConnection.connectionState === 'connected') {
      const video = document.getElementById('remote-video');
      console.log('Video element:', 'srcObject:', !!video.srcObject, 'readyState:', video.readyState,
        'paused:', video.paused, 'videoWidth:', video.videoWidth, 'videoHeight:', video.videoHeight);
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(t =>
          console.log('  Track:', t.kind, 'enabled:', t.enabled, 'muted:', t.muted, 'readyState:', t.readyState));
      }
      video.play().catch(e => console.error('Force play failed:', e));
    }
  };
}

async function handleOffer(offerData) {
  createPeerConnection();
  await peerConnection.setRemoteDescription({ type: 'offer', sdp: offerData.sdp });
  const answer = await peerConnection.createAnswer();
  await peerConnection.setLocalDescription(answer);
  ws.send(JSON.stringify({
    type: 'answer',
    call_id: currentCallId,
    sdp: answer.sdp
  }));
}

// ─── Dashboard WebSocket ──────────────────────────────────────────────────────
function connectDashboard() {
  const wsProto = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const wsUrl = `${wsProto}://${window.location.host}/ws/dashboard`;
  ws = new WebSocket(wsUrl);

  ws.onopen = () => {
    console.log('Dashboard WS connected');
    document.getElementById('conn-status').classList.add('connected');
    document.getElementById('conn-status').title = 'Connected';
    document.getElementById('conn-label').textContent = 'Connected';
  };
  // Uncomment to test local camera feed in the dashboard without WebRTC
  // startLocalPreview();

  ws.onmessage = async (event) => {
    const data = JSON.parse(event.data);

    switch (data.type) {
      case 'incoming_call':
        onIncomingCall(data);
        break;
      case 'dispatcher_ready':
        break;
      case 'triage_update':
        onTriageUpdate(data.report);
        break;
      case 'critical_flag':
        onCriticalFlag(data);
        break;
      case 'vitals':
        onVitals(data);
        break;
      case 'call_ended':
        onCallEnded(data);
        break;
      case 'offer':
        if (data.call_id) currentCallId = data.call_id;
        await handleOffer(data);
        break;
      case 'ice':
        if (peerConnection) {
          await peerConnection.addIceCandidate({
            candidate: data.candidate,
            sdpMid: data.sdpMid,
            sdpMLineIndex: data.sdpMLineIndex
          });
        }
        break;
      case 'incident_update':
        onIncidentUpdate(data);
        break;
      case 'incident_closed':
        onIncidentClosed(data);
        break;
      case 'active_incidents':
        onActiveIncidents(data);
        break;
    }
  };

  ws.onclose = () => {
    console.log('Dashboard WS closed, reconnecting in 2s...');
    document.getElementById('conn-status').classList.remove('connected');
    document.getElementById('conn-status').title = 'Disconnected';
    document.getElementById('conn-label').textContent = 'Disconnected';
    setTimeout(connectDashboard, 2000);
  };
}

// ─── Event Handlers ───────────────────────────────────────────────────────────
async function startLocalPreview() {
  try {
    const video = document.getElementById('remote-video');
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    video.srcObject = stream;
    // local camera preview started
  } catch (e) {
    console.error('Failed to start local preview', e);
  }
}

function onIncomingCall(data) {
  currentCallId = data.call_id;
  const banner = document.getElementById('incoming-banner');
  banner.classList.add('visible');

  const loc = data.location;
  if (loc?.lat) {
    document.getElementById('incoming-location').textContent =
      `${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)}`;
    updateMapPin(loc.lat, loc.lng);
  }
}

document.getElementById('answer-btn').onclick = () => {
  if (!currentCallId || !ws) return;
  document.getElementById('incoming-banner').classList.remove('visible');
  document.getElementById('video-controls').classList.add('visible');

  ws.send(JSON.stringify({
    type: 'dispatcher_joined',
    call_id: currentCallId
  }));
};

document.getElementById('vc-end-btn').onclick = () => {
  if (!ws || !currentCallId) return;
  ws.send(JSON.stringify({ type: 'call_ended', call_id: currentCallId }));
  onCallEnded({ reason: 'dispatcher_ended' });
};

document.getElementById('mute-btn').onclick = () => {
  const video = document.getElementById('remote-video');
  video.muted = !video.muted;
  const btn = document.getElementById('mute-btn');
  const icon = document.getElementById('mute-icon');
  if (video.muted) {
    icon.innerHTML = '<line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2c0 .76-.12 1.5-.34 2.18"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line>';
  } else {
    icon.innerHTML = '<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line>';
  }
  btn.classList.toggle('muted', video.muted);
};

function onVitals(data) {
  const hrConf = data.hrConfidence ?? 0;
  const brConf = data.breathingConfidence ?? 0;
  const signalLost = document.getElementById('signal-lost');

  // Show warning only when confidence is very low (< 0.4 = essentially no reading)
  // Presage sends 1.0 (stable) or 0.5 (unstable) — unstable is still usable data
  signalLost.style.display = (hrConf < 0.4 || brConf < 0.4) ? 'block' : 'none';

  // Always show vitals values — dispatchers need to see whatever data we have.
  // Confidence bar communicates reliability; hiding values helps no one.
  if (data.hr != null) {
    document.getElementById('hr-value').textContent = Math.round(data.hr);
    document.getElementById('hr-conf').style.width = `${Math.round(hrConf * 100)}%`;
    document.getElementById('hr-conf').style.background = hrConf >= 0.4 ? '#00cc44' : '#ffaa00';
  }
  if (data.breathing != null) {
    document.getElementById('br-value').textContent = Math.round(data.breathing);
    document.getElementById('br-conf').style.width = `${Math.round(brConf * 100)}%`;
    document.getElementById('br-conf').style.background = brConf >= 0.4 ? '#00cc44' : '#ffaa00';
  }
}

function onTriageUpdate(report) {
  document.getElementById('situation').textContent = report.situation_summary ?? '--';
  document.getElementById('emotional-state').textContent = report.caller_emotional_state ?? '--';
  document.getElementById('response-type').textContent = report.recommended_response_type ?? '--';
  document.getElementById('can-speak').textContent = report.can_speak ? 'Yes' : 'No';
  document.getElementById('keywords').textContent = (report.detected_keywords ?? []).join(', ') || '--';
  document.getElementById('severity-label').textContent = report.severity ?? '--';

  // Update severity dots
  for (let i = 1; i <= 5; i++) {
    const dot = document.getElementById(`sev${i}`);
    dot.className = 'severity-dot';
    if (i <= (report.severity ?? 0)) {
      dot.classList.add('active');
      if (report.severity <= 2) dot.classList.add('low');
      else if (report.severity <= 3) dot.classList.add('mid');
    }
  }

  if ((report.severity ?? 0) >= 4) {
    document.body.classList.add('critical-state');
  } else {
    document.body.classList.remove('critical-state');
  }
}

function onCriticalFlag(data) {
  const alert = document.getElementById('critical-alert');
  alert.textContent = `⚠ CRITICAL: ${data.reason}`;
  alert.style.display = 'block';
  playAlert();
  setTimeout(() => { alert.style.display = 'none'; }, 10000);
}

function onCallEnded(data) {
  // Hide call UI
  document.getElementById('video-controls').classList.remove('visible');
  document.getElementById('incoming-banner').classList.remove('visible');
  document.body.classList.remove('critical-state');
  document.getElementById('critical-alert').style.display = 'none';

  // Tear down WebRTC
  if (peerConnection) {
    peerConnection.close();
    peerConnection = null;
  }
  document.getElementById('remote-video').srcObject = null;

  // Reset vitals
  document.getElementById('hr-value').textContent = '--';
  document.getElementById('br-value').textContent = '--';
  document.getElementById('hr-conf').style.width = '0%';
  document.getElementById('br-conf').style.width = '0%';
  document.getElementById('signal-lost').style.display = 'none';

  // Reset triage
  document.getElementById('situation').textContent = 'Call ended';
  document.getElementById('emotional-state').textContent = '--';
  document.getElementById('response-type').textContent = '--';
  document.getElementById('can-speak').textContent = '--';
  document.getElementById('keywords').textContent = '--';
  document.getElementById('severity-label').textContent = '--';
  for (let i = 1; i <= 5; i++) {
    document.getElementById(`sev${i}`).className = 'severity-dot';
  }

  // Reset mute button
  const muteBtn = document.getElementById('mute-btn');
  muteBtn.textContent = '\uD83D\uDD07';
  muteBtn.classList.add('muted');
  document.getElementById('remote-video').muted = true;

  // Clear map marker
  if (mapMarker) {
    map.removeLayer(mapMarker);
    mapMarker = null;
  }

  currentCallId = null;
}

function playAlert() {
  try {
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.value = 880;
    gain.gain.setValueAtTime(0.3, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
    osc.start();
    osc.stop(ctx.currentTime + 0.5);
  } catch (e) {}
}

// ─── Incident Tracking ───────────────────────────────────────────────────────
function flashVal(el, newVal) {
  const prev = el.textContent;
  el.textContent = newVal;
  if (String(prev) !== String(newVal)) {
    el.classList.remove('flash');
    void el.offsetWidth; // force reflow to restart animation
    el.classList.add('flash');
  }
}

function updateCommunityMetrics() {
  const ids = Object.keys(incidentData);
  let totalReports = 0, totalAlerted = 0;
  for (const inc of Object.values(incidentData)) {
    totalReports += inc.report_count || 0;
    totalAlerted += inc.alerted_count || 0;
  }
  flashVal(document.querySelector('#cm-incidents .cm-val'), ids.length);
  flashVal(document.querySelector('#cm-reports .cm-val'), totalReports);
  flashVal(document.querySelector('#cm-alerted .cm-val'), totalAlerted);

  document.getElementById('cm-incidents').classList.toggle('hot', ids.length > 0);
}

function upsertIncidentMarker(incidentId, inc) {
  if (!map) initMap();
  const lat = inc.location?.lat;
  const lng = inc.location?.lng;
  if (!lat || !lng) return;

  const sevClass = (inc.severity_avg || 0) <= 2 ? 'sev-low' : (inc.severity_avg || 0) <= 3 ? 'sev-mid' : '';
  const icon = L.divIcon({
    className: '',
    html: `<div class="incident-badge ${sevClass}">${inc.report_count || 1}</div>`,
    iconSize: [28, 28],
    iconAnchor: [14, 14],
  });

  if (incidentMarkers[incidentId]) {
    incidentMarkers[incidentId].setIcon(icon);
    incidentMarkers[incidentId].setLatLng([lat, lng]);
  } else {
    incidentMarkers[incidentId] = L.marker([lat, lng], { icon })
      .addTo(map)
      .bindPopup(`Incident: ${inc.report_count} report(s)`);
  }
  incidentMarkers[incidentId].setPopupContent(`Incident: ${inc.report_count} report(s) · ${inc.alerted_count || 0} alerted`);
}

function onIncidentUpdate(data) {
  const id = data.incident_id;
  incidentData[id] = {
    location: data.location,
    report_count: data.report_count,
    alerted_count: data.alerted_count || 0,
    severity_avg: data.severity_avg || 0,
  };
  upsertIncidentMarker(id, incidentData[id]);
  updateCommunityMetrics();
}

function onIncidentClosed(data) {
  const id = data.incident_id;
  delete incidentData[id];
  if (incidentMarkers[id]) {
    map.removeLayer(incidentMarkers[id]);
    delete incidentMarkers[id];
  }
  updateCommunityMetrics();
}

function onActiveIncidents(data) {
  for (const inc of (data.incidents || [])) {
    incidentData[inc.incident_id] = inc;
    upsertIncidentMarker(inc.incident_id, inc);
  }
  updateCommunityMetrics();
}

// ─── Init ─────────────────────────────────────────────────────────────────────
initMap();
connectDashboard();
</script>
</body>
</html>
